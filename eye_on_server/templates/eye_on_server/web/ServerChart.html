{% extends 'eye_on_server/web/base.html' %}
{% load static %}
{% block breadcrumb %}
  <span class="layui-breadcrumb" lay-separator=">">
  <a href="{% url 'ServerChart' %}">首页</a>
  <a href="{% url 'ServerChart' %}">资源折线图</a>
</span>
{% endblock %}
{% block search %}
    <li class="layui-nav-item layui-show-xs-inline-block " lay-header-event="menuLeft"></li>
      <li class="layui-nav-item layui-hide-xs" style="display: inline-block;padding-right: 10px">
         <div class="layui-input-group">
            <label>
                <input type="text" placeholder="搜索......" class="layui-input" lay-options="{split:true}" id="searchInput">
            </label>
            <div class=" layui-input-suffix" style="cursor: pointer;"><!--class="layui-input-split"-->
                <i class="layui-icon layui-icon-search search" style="font-size: 15px;" lay-affix="search" id="searchIcon" lay-event="search"></i>
            </div>
         </div>
      </li>
    <script src="{% static "/eye_on_server/js/layui.js" %}"></script>
    <script src="{% static 'eye_on_server/js/echarts/echarts.min.js' %}"></script>
    <script>
    //JS
    layui.use(['element', 'layer', 'util', 'form','jquery'], function() {
        let layer = layui.layer;
        let $ = layui.$;

        //回车后搜素
        $(".layui-input").keydown(function (e) {
            if (e.which === 13) {
                e.preventDefault();
                performSearch();
            }
        });
        //点击搜索键搜索
        document.getElementById('searchIcon').addEventListener('click', function () {
            performSearch();
        });

        function performSearch() {
            let searchInput = document.getElementById('searchInput');
            let searchValue = searchInput.value;

            if (searchValue.trim() === '') {
                layui.layer.msg('请输入搜索内容');
                return;
            }

            console.log(searchValue);

            $.ajax({
                url: '{% url 'search' %}',
                type: 'GET',
                data: {keywords: searchValue},
                success: function (response) {
                    displaySearchResults(response,searchValue);
                },
                error: function () {
                    layer.msg('搜索请求失败');
                }
            });
        }

        function displaySearchResults(results,searchValue) {
            let searchResultsDiv = $('#searchResults');
            searchResultsDiv.empty();

            if (results.length === 0) {
                searchResultsDiv.text('未找到匹配的结果');
            } else {
                for (let i = 0; i < results.length; i++) {
                    let resultItem = $('<div>').text(results[i]);
                    searchResultsDiv.append(resultItem);
                }

                // 搜索跳转
                window.location.href = 'search/?keywords=' + encodeURIComponent(searchValue);
            }
        }
    })
    </script>
{% endblock %}
{% block ServerChart %}
<div class="layui-bg-grey" >
  <div class="layui-row layui-col-space15" >
    {% for data_line in data_lines %}
        {% block DayChart %}{% endblock %}
    <div class="layui-col-md4" style="padding: 40px;">
      <div class="layui-card">
        <div class="layui-card-header ">
            <a>磁盘当前使用率</a>
            <div class="layui-form " style="float: right;width: auto;position: relative;">
                <input type="radio" value="all-day" name="data-show" title="全部" lay-filter="demo-radio-filter" checked data-index="{{ forloop.counter0 }}">
                <input type="radio" value="yesterday" name="data-show" title="昨天" lay-filter="demo-radio-filter" data-index="{{ forloop.counter0 }}">
                <input type="radio" value="today" name="data-show" title="今天" lay-filter="demo-radio-filter" data-index="{{ forloop.counter0 }}">
            </div>
            <div class="layui-progress layui-progress-big" lay-showpercent="true" style="width: auto;position: relative; ">
                <div class="layui-progress-bar" lay-percent="{{disk_percent.pop}}%" style="width: 100% ;position: absolute;"></div>
            </div>
        </div>
          <br>
        <div class="layui-card-body" >
            <div class="layui-row " >
                <div class="layui-container" id="layui-col-md4" style="width: 400px;height: 400px" >
                    {{ data_line |safe }}<br>
                </div>
            </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
<script src="{% static 'eye_on_server/js/layui.js' %}"></script>
<script>
    let progressBarList = document.querySelectorAll('.layui-progress-bar');
    progressBarList.forEach(function (progressBar){
        let diskPercent = parseInt(progressBar.getAttribute('lay-percent'), 10);
        if (diskPercent > 80){
            progressBar.classList.add('layui-bg-red');
        }else if(diskPercent>60){
            progressBar.classList.add('layui-bg-orange');
        }else{
            progressBar.classList.add('layui-bg-primary');
        }
     });

    layui.use(['form', 'jquery'],function(){
      var form = layui.form;
      var layer = layui.layer;
      var $ = layui.$;
      // radio 事件
      form.on('radio(demo-radio-filter)', function(data){
        var elem = data.elem; // 获得 radio 原始 DOM 对象
        var checked = elem.checked; // 获得 radio 选中状态
        var value = elem.value; // 获得 radio 值
        var othis = data.othis; // 获得 radio 元素被替换后的 jQuery 对象
        var dataIndex = elem.getAttribute('data-index');
          console.log(dataIndex)
        var dataLine = JSON.parse('{{ data_lines|escapejs }}');
        var now = new Date();
        var year = now.getFullYear();
        var month = now.getMonth()+1;
        if(month<10)
          month = "0" + month;
        var day = now.getDate();//当前日期
        var time;
        if(day<10)
          day = "0" + day;
        if(value==="yesterday"){
          time=year+"-"+month+"-"+day-1;
         }
        if (value === "today") {
          time = year + "-" + month + "-" + day;
         }
        if (value === "all-day") {
          time = "1";
         }
          // 根据条件判断是否禁用单选按钮
        if (isNaN(time)) {
          $('input[value="yesterday"]').not(elem).prop('disabled', true);
          form.render('radio');
        } else {
          $('input[value="yesterday"]').prop('disabled', false);
          form.render('radio');
        }
        {#layer.msg(['value: '+ value, 'checked: '+ checked].join('<br>'));#}
        if(value==='yesterday' || value==='today')
        {
            $.ajax({
                url:'{% url 'DayChart' %}',
                type:'GET',
                data:{'date':time, 'value':value, 'dataIndex':dataIndex},
                success:function (data){
                    if(data.message){
                        layer.msg(data.message);
                    }else {

                        {#window.location.href=this.url;#}
                    }
                },
                error:function (xhr, status, error){
                    console.error("Error:", error);
                }
            })
        }
      });
    })
</script>
{% endblock %}
